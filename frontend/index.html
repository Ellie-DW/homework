<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ì˜¤ëŠ˜ ìˆ˜ìµ/ì§€ì¶œ ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      text-align: center;
    }
    .card h3 {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .card .amount {
      font-size: 2em;
      font-weight: bold;
      margin: 10px 0;
    }
    .income { color: #10b981; }
    .expense { color: #ef4444; }
    .balance { color: #3b82f6; }
    .input-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #666;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    .btn-group {
      display: flex;
      gap: 10px;
    }
    button {
      flex: 1;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .btn-income {
      background: #10b981;
      color: white;
    }
    .btn-expense {
      background: #ef4444;
      color: white;
    }
    .transactions {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .transactions h2 {
      margin-bottom: 20px;
      color: #333;
    }
    .transaction-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #e5e7eb;
      transition: background 0.2s;
    }
    .transaction-item:hover {
      background: #f9fafb;
    }
    .transaction-info {
      flex: 1;
    }
    .transaction-type {
      font-size: 0.8em;
      padding: 3px 8px;
      border-radius: 5px;
      display: inline-block;
      margin-bottom: 5px;
    }
    .type-income {
      background: #d1fae5;
      color: #065f46;
    }
    .type-expense {
      background: #fee2e2;
      color: #991b1b;
    }
    .transaction-amount {
      font-size: 1.3em;
      font-weight: bold;
      margin-right: 15px;
    }
    .btn-delete {
      padding: 8px 15px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .btn-delete:hover {
      background: #dc2626;
    }
    .btn-edit {
      padding: 8px 15px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      margin-right: 5px;
    }
    .btn-edit:hover {
      background: #2563eb;
    }
    .transaction-actions {
      display: flex;
      gap: 5px;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }
    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: white;
      padding: 10px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .tab {
      flex: 1;
      padding: 15px;
      background: #f3f4f6;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      color: #666;
    }
    .tab:hover {
      background: #e5e7eb;
    }
    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
    }
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }
    /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
    .calendar-container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .calendar-header h2 {
      color: #333;
      font-size: 1.5em;
    }
    .calendar-nav {
      display: flex;
      gap: 10px;
    }
    .calendar-nav button {
      padding: 8px 15px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .calendar-nav button:hover {
      background: #764ba2;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day-header {
      text-align: center;
      padding: 10px;
      font-weight: bold;
      color: #666;
      background: #f3f4f6;
      border-radius: 5px;
    }
    .calendar-day {
      min-height: 100px;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .calendar-day:hover {
      border-color: #667eea;
      background: #f9fafb;
    }
    .calendar-day.today {
      background: #fef3c7;
      border-color: #f59e0b;
    }
    .calendar-day.other-month {
      opacity: 0.3;
      cursor: default;
    }
    .calendar-day.other-month:hover {
      border-color: #e5e7eb;
      background: transparent;
    }
    .calendar-day-number {
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    .calendar-day-income {
      font-size: 0.85em;
      color: #10b981;
      font-weight: bold;
    }
    .calendar-day-expense {
      font-size: 0.85em;
      color: #ef4444;
      font-weight: bold;
    }
    .calendar-day-balance {
      font-size: 0.75em;
      color: #666;
      margin-top: 5px;
      padding-top: 5px;
      border-top: 1px solid #e5e7eb;
    }
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-close {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .modal-close:hover {
      background: #dc2626;
    }
    /* ìˆ˜ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .edit-form {
      margin-top: 20px;
    }
    .edit-form .input-group {
      margin-bottom: 15px;
    }
    .edit-form label {
      display: block;
      margin-bottom: 5px;
      color: #666;
      font-weight: bold;
    }
    .edit-form input, .edit-form select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
    }
    .edit-form input:focus, .edit-form select:focus {
      outline: none;
      border-color: #667eea;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn-save {
      flex: 1;
      padding: 15px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }
    .btn-save:hover {
      background: #059669;
    }
    .btn-cancel {
      flex: 1;
      padding: 15px;
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }
    .btn-cancel:hover {
      background: #4b5563;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’° ì˜¤ëŠ˜ ìˆ˜ìµ/ì§€ì¶œ ê´€ë¦¬</h1>
    
    <!-- íƒ­ ë©”ë‰´ -->
    <div class="tabs">
      <button class="tab active" onclick="switchView('today')">ğŸ“Š ì˜¤ëŠ˜</button>
      <button class="tab" onclick="switchView('calendar')">ğŸ“… ë‹¬ë ¥</button>
    </div>

    <!-- ì˜¤ëŠ˜ í™”ë©´ -->
    <div id="todayView" class="view active">
    <!-- ìš”ì•½ ì¹´ë“œ -->
    <div class="summary-cards">
      <div class="card">
        <h3>ì´ ìˆ˜ìµ</h3>
        <div class="amount income" id="totalIncome">0ì›</div>
      </div>
      <div class="card">
        <h3>ì´ ì§€ì¶œ</h3>
        <div class="amount expense" id="totalExpense">0ì›</div>
      </div>
      <div class="card">
        <h3>ìˆœì´ìµ</h3>
        <div class="amount balance" id="balance">0ì›</div>
      </div>
    </div>

    <!-- ì…ë ¥ ì„¹ì…˜ -->
    <div class="input-section">
      <h2>ìƒˆ ê±°ë˜ ì¶”ê°€</h2>
      <div class="input-group">
        <label for="amount">ê¸ˆì•¡</label>
        <input type="number" id="amount" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" min="0">
      </div>
      <div class="input-group">
        <label for="description">ì„¤ëª… (ì„ íƒ)</label>
        <input type="text" id="description" placeholder="ì˜ˆ: ì ì‹¬ ì‹ì‚¬, ì›”ê¸‰ ë“±">
      </div>
      <div class="btn-group">
        <button class="btn-income" onclick="addTransaction('income')">ğŸ’µ ìˆ˜ìµ ì¶”ê°€</button>
        <button class="btn-expense" onclick="addTransaction('expense')">ğŸ’¸ ì§€ì¶œ ì¶”ê°€</button>
      </div>
    </div>

    <!-- ê±°ë˜ ë‚´ì—­ -->
    <div class="transactions">
      <h2>ì˜¤ëŠ˜ì˜ ê±°ë˜ ë‚´ì—­</h2>
      <div id="transactionList"></div>
    </div>
    </div>

    <!-- ë‹¬ë ¥ í™”ë©´ -->
    <div id="calendarView" class="view">
      <div class="calendar-container">
        <div class="calendar-header">
          <h2 id="calendarTitle">2025ë…„ 11ì›”</h2>
          <div class="calendar-nav">
            <button onclick="changeMonth(-1)">â—€ ì´ì „</button>
            <button onclick="changeMonth(0)">ì˜¤ëŠ˜</button>
            <button onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button>
          </div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <!-- ë‹¬ë ¥ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>
  </div>

  <!-- ë‚ ì§œë³„ ìƒì„¸ ëª¨ë‹¬ -->
  <div id="dateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalDate">2025-11-06</h2>
        <button class="modal-close" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
      <div id="modalTransactions"></div>
    </div>
  </div>

  <!-- ê±°ë˜ ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ê±°ë˜ ìˆ˜ì •</h2>
        <button class="modal-close" onclick="closeEditModal()">ë‹«ê¸°</button>
      </div>
      <div class="edit-form">
        <div class="input-group">
          <label for="editType">ìœ í˜•</label>
          <select id="editType">
            <option value="income">ìˆ˜ìµ</option>
            <option value="expense">ì§€ì¶œ</option>
          </select>
        </div>
        <div class="input-group">
          <label for="editAmount">ê¸ˆì•¡</label>
          <input type="number" id="editAmount" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" min="0">
        </div>
        <div class="input-group">
          <label for="editDescription">ì„¤ëª… (ì„ íƒ)</label>
          <input type="text" id="editDescription" placeholder="ì˜ˆ: ì ì‹¬ ì‹ì‚¬, ì›”ê¸‰ ë“±">
        </div>
        <div class="modal-actions">
          <button class="btn-save" onclick="saveEditTransaction()">ì €ì¥</button>
          <button class="btn-cancel" onclick="closeEditModal()">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const api = 'http://localhost:5000';
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let editingTransactionId = null;

    // í˜ì´ì§€ ë¡œë“œë˜ë©´ ì‹¤í–‰
    window.onload = () => {
      loadSummary();
      loadTransactions();
      loadCalendar();
    }

    // íƒ­ í´ë¦­í•˜ë©´ í™”ë©´ ì „í™˜
    function switchView(view) {
      // active í´ë˜ìŠ¤ ë‹¤ ì œê±°
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      
      const views = document.querySelectorAll('.view');
      views.forEach(v => v.classList.remove('active'));
      
      // í´ë¦­í•œ íƒ­ í™œì„±í™”
      event.target.classList.add('active');
      
      if (view === 'today') {
        document.getElementById('todayView').classList.add('active');
      } else {
        document.getElementById('calendarView').classList.add('active');
        loadCalendar(); // ë‹¬ë ¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      }
    }

    // ìš”ì•½ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function loadSummary() {
      fetch(api + '/summary')
        .then(res => res.json())
        .then(data => {
          // ìˆ«ìì— ì½¤ë§ˆ ì°ê¸°
          document.getElementById('totalIncome').textContent = data.totalIncome.toLocaleString() + 'ì›';
          document.getElementById('totalExpense').textContent = data.totalExpense.toLocaleString() + 'ì›';
          document.getElementById('balance').textContent = data.balance.toLocaleString() + 'ì›';
          
          // ìˆœì´ìµ ì–‘ìˆ˜ë©´ ì´ˆë¡ìƒ‰, ìŒìˆ˜ë©´ ë¹¨ê°„ìƒ‰
          const balanceEl = document.getElementById('balance');
          if (data.balance >= 0) {
            balanceEl.className = 'amount income';
          } else {
            balanceEl.className = 'amount expense';
          }
        })
        .catch(err => console.error('ìš”ì•½ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', err));
    }

    // ì˜¤ëŠ˜ ê±°ë˜ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadTransactions() {
      fetch(api + '/transactions')
        .then(res => res.json())
        .then(data => {
          const listEl = document.getElementById('transactionList');
          
          // ê±°ë˜ë‚´ì—­ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
          if (data.length === 0) {
            listEl.innerHTML = '<div class="empty-state">ì•„ì§ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
          }

          listEl.innerHTML = data.map(item => `
            <div class="transaction-item">
              <div class="transaction-info">
                <span class="transaction-type ${item.type === 'income' ? 'type-income' : 'type-expense'}">
                  ${item.type === 'income' ? 'ìˆ˜ìµ' : 'ì§€ì¶œ'}
                </span>
                <div>${item.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                <small style="color: #9ca3af;">${new Date(item.created_at).toLocaleTimeString('ko-KR')}</small>
              </div>
              <span class="transaction-amount ${item.type === 'income' ? 'income' : 'expense'}">
                ${item.type === 'income' ? '+' : '-'}${item.amount.toLocaleString()}ì›
              </span>
              <div class="transaction-actions">
                <button class="btn-edit" onclick="openEditModal(${item.id}, '${item.type}', ${item.amount}, '${(item.description || '').replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                <button class="btn-delete" onclick="deleteTransaction(${item.id})">ì‚­ì œ</button>
              </div>
            </div>
          `).join('');
        })
        .catch(err => console.error('ê±°ë˜ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', err));
    }

    // ê±°ë˜ ì¶”ê°€í•˜ê¸°
    function addTransaction(type) {
      const amountInput = document.getElementById('amount');
      const descInput = document.getElementById('description');
      
      const amount = parseInt(amountInput.value);
      const description = descInput.value;

      // ê¸ˆì•¡ ê²€ì¦
      if (!amount || amount <= 0) {
        alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      // api í˜¸ì¶œ
      fetch(api + '/transactions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: type, amount: amount, description: description })
      })
        .then(res => res.json())
        .then(data => {
          // ì…ë ¥ì°½ ë¹„ìš°ê¸°
          amountInput.value = '';
          descInput.value = '';
          
          // í™”ë©´ ìƒˆë¡œê³ ì¹¨
          loadSummary();
          loadTransactions();
          
          if(type === 'income') {
            alert('ìˆ˜ìµì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
          } else {
            alert('ì§€ì¶œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
          }
        })
        .catch(err => {
          console.error('ê±°ë˜ ì¶”ê°€ ì‹¤íŒ¨:', err);
          alert('ê±°ë˜ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        });
    }

    // ì‚­ì œí•˜ê¸°
    function deleteTransaction(id) {
      // í™•ì¸ ë©”ì‹œì§€
      if (!confirm('ì´ ê±°ë˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      fetch(api + '/transactions/' + id, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          // ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          loadSummary();
          loadTransactions();
          alert('ê±°ë˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        })
        .catch(err => {
          console.error('ê±°ë˜ ì‚­ì œ ì‹¤íŒ¨:', err);
          alert('ê±°ë˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        });
    }

    // ë‹¬ë ¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadCalendar() {
      const url = api + '/transactions/monthly/' + currentYear + '/' + currentMonth;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          renderCalendar(data);
        })
        .catch(err => console.error('ë‹¬ë ¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err));
    }

    // ë‹¬ë ¥ ê·¸ë¦¬ê¸°
    function renderCalendar(transactions) {
      // ë‚ ì§œ ê³„ì‚°
      const firstDay = new Date(currentYear, currentMonth - 1, 1);
      const lastDay = new Date(currentYear, currentMonth, 0);
      const prevLastDay = new Date(currentYear, currentMonth - 1, 0);
      
      const firstDayIndex = firstDay.getDay(); // ì²«ë‚  ìš”ì¼
      const lastDateNum = lastDay.getDate(); // ë§ˆì§€ë§‰ ë‚ ì§œ
      const prevLastDateNum = prevLastDay.getDate(); // ì´ì „ë‹¬ ë§ˆì§€ë§‰ ë‚ ì§œ
      
      // ì œëª© ì—…ë°ì´íŠ¸
      document.getElementById('calendarTitle').textContent = currentYear + 'ë…„ ' + currentMonth + 'ì›”';
      
      // ê±°ë˜ ë°ì´í„° ë§µìœ¼ë¡œ ë§Œë“¤ê¸° (ë‚ ì§œë³„ë¡œ)
      const transactionMap = {};
      for(let i = 0; i < transactions.length; i++) {
        const t = transactions[i];
        const date = t.date.split('T')[0];
        transactionMap[date] = t;
      }
      
      let html = '';
      
      // ìš”ì¼ í—¤ë”
      const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      days.forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
      });
      
      // ì´ì „ ë‹¬ ë‚ ì§œë“¤
      for (let i = firstDayIndex - 1; i >= 0; i--) {
        html += `<div class="calendar-day other-month">
          <div class="calendar-day-number">${prevLastDateNum - i}</div>
        </div>`;
      }
      
      // í˜„ì¬ ë‹¬ ë‚ ì§œë“¤
      const today = new Date();
      for (let i = 1; i <= lastDateNum; i++) {
        const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        const trans = transactionMap[dateStr];
        const isToday = today.getFullYear() === currentYear && 
                       today.getMonth() + 1 === currentMonth && 
                       today.getDate() === i;
        
        html += `<div class="calendar-day ${isToday ? 'today' : ''}" onclick="showDateDetails('${dateStr}')">
          <div class="calendar-day-number">${i}</div>`;
        
        if (trans) {
          if (trans.income > 0) {
            html += `<div class="calendar-day-income">+${trans.income.toLocaleString()}ì›</div>`;
          }
          if (trans.expense > 0) {
            html += `<div class="calendar-day-expense">-${trans.expense.toLocaleString()}ì›</div>`;
          }
          const balance = trans.income - trans.expense;
          html += `<div class="calendar-day-balance">ìˆœì´ìµ: ${balance.toLocaleString()}ì›</div>`;
        }
        
        html += `</div>`;
      }
      
      // ë‹¤ìŒ ë‹¬ ë‚ ì§œë“¤
      const totalCells = html.match(/calendar-day/g).length - 7; // í—¤ë” ì œì™¸
      const remainingCells = 35 - totalCells; // 5ì£¼(35ì¹¸) ê¸°ì¤€
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">
          <div class="calendar-day-number">${i}</div>
        </div>`;
      }
      
      document.getElementById('calendarGrid').innerHTML = html;
    }

    // ì´ì „/ë‹¤ìŒ ë‹¬ë¡œ ì´ë™
    function changeMonth(direction) {
      if (direction === 0) {
        // ì˜¤ëŠ˜ ë²„íŠ¼ ëˆ„ë¥´ë©´
        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth() + 1;
      } else {
        currentMonth = currentMonth + direction;
        
        // 12ì›” ë„˜ì–´ê°€ë©´ ë‚´ë…„ 1ì›”ë¡œ
        if (currentMonth > 12) {
          currentMonth = 1;
          currentYear++;
        }
        // 1ì›” ì´ì „ì´ë©´ ì‘ë…„ 12ì›”ë¡œ
        else if (currentMonth < 1) {
          currentMonth = 12;
          currentYear--;
        }
      }
      
      loadCalendar(); // ë‹¬ë ¥ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }

    // ë‚ ì§œ ìƒì„¸ ë³´ê¸°
    function showDateDetails(date) {
      fetch(api + `/transactions/date/${date}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('modalDate').textContent = date;
          
          if (data.length === 0) {
            document.getElementById('modalTransactions').innerHTML = 
              '<div class="empty-state">ì´ ë‚ ì§œì—ëŠ” ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          } else {
            let totalIncome = 0;
            let totalExpense = 0;
            
            const html = data.map(item => {
              if (item.type === 'income') totalIncome += item.amount;
              else totalExpense += item.amount;
              
              return `
                <div class="transaction-item">
                  <div class="transaction-info">
                    <span class="transaction-type ${item.type === 'income' ? 'type-income' : 'type-expense'}">
                      ${item.type === 'income' ? 'ìˆ˜ìµ' : 'ì§€ì¶œ'}
                    </span>
                    <div>${item.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                    <small style="color: #9ca3af;">${new Date(item.created_at).toLocaleTimeString('ko-KR')}</small>
                  </div>
                  <span class="transaction-amount ${item.type === 'income' ? 'income' : 'expense'}">
                    ${item.type === 'income' ? '+' : '-'}${item.amount.toLocaleString()}ì›
                  </span>
                  <div class="transaction-actions">
                    <button class="btn-edit" onclick="openEditModal(${item.id}, '${item.type}', ${item.amount}, '${(item.description || '').replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                    <button class="btn-delete" onclick="deleteTransaction(${item.id})">ì‚­ì œ</button>
                  </div>
                </div>
              `;
            }).join('');
            
            const summary = `
              <div style="background: #f9fafb; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>ì´ ìˆ˜ìµ:</span>
                  <span class="income" style="font-weight: bold;">+${totalIncome.toLocaleString()}ì›</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>ì´ ì§€ì¶œ:</span>
                  <span class="expense" style="font-weight: bold;">-${totalExpense.toLocaleString()}ì›</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid #e5e7eb;">
                  <span style="font-weight: bold;">ìˆœì´ìµ:</span>
                  <span class="${totalIncome - totalExpense >= 0 ? 'income' : 'expense'}" style="font-weight: bold; font-size: 1.2em;">
                    ${(totalIncome - totalExpense).toLocaleString()}ì›
                  </span>
                </div>
              </div>
            `;
            
            document.getElementById('modalTransactions').innerHTML = summary + html;
          }
          
          document.getElementById('dateModal').classList.add('active');
        })
        .catch(err => console.error('ë‚ ì§œ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:', err));
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
      document.getElementById('dateModal').classList.remove('active');
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('dateModal').addEventListener('click', (e) => {
      if (e.target.id === 'dateModal') {
        closeModal();
      }
    });

    // ìˆ˜ì • ë²„íŠ¼ í´ë¦­
    function openEditModal(id, type, amount, description) {
      editingTransactionId = id; // ìˆ˜ì •í•  ê±°ë˜ id ì €ì¥
      
      // í¼ì— ê¸°ì¡´ ë°ì´í„° ë„£ê¸°
      document.getElementById('editType').value = type;
      document.getElementById('editAmount').value = amount;
      document.getElementById('editDescription').value = description;
      
      // ëª¨ë‹¬ ì—´ê¸°
      document.getElementById('editModal').classList.add('active');
    }

    // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
    function closeEditModal() {
      editingTransactionId = null;
      document.getElementById('editModal').classList.remove('active');
      
      // ì…ë ¥ê°’ ì´ˆê¸°í™”
      document.getElementById('editAmount').value = '';
      document.getElementById('editDescription').value = '';
    }

    // ìˆ˜ì • ë‚´ìš© ì €ì¥
    function saveEditTransaction() {
      const type = document.getElementById('editType').value;
      const amountValue = document.getElementById('editAmount').value;
      const description = document.getElementById('editDescription').value;
      
      const amount = parseInt(amountValue);

      // ê²€ì¦
      if (!amount || amount <= 0) {
        alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      // api í˜¸ì¶œ
      const url = api + '/transactions/' + editingTransactionId;
      fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          type: type, 
          amount: amount, 
          description: description 
        })
      })
        .then(res => res.json())
        .then(data => {
          closeEditModal(); // ëª¨ë‹¬ ë‹«ê¸°
          
          // í™”ë©´ ê°±ì‹ 
          loadSummary();
          loadTransactions();
          loadCalendar();
          
          alert('ê±°ë˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        })
        .catch(err => {
          console.error('ê±°ë˜ ìˆ˜ì • ì‹¤íŒ¨:', err);
          alert('ê±°ë˜ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        });
    }

    // ìˆ˜ì • ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target.id === 'editModal') {
        closeEditModal();
      }
    });
  </script>
</body>
</html>

